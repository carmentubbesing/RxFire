---
title: "CalMAPPER"
output: 
  html_document:
    toc: TRUE
date: '2022-07-26'
editor_options: 
  chunk_output_type: console
---

```{r, include = F}
require(tidyverse)
require(lubridate)
require(sf)
require(fs)
require(mapview)
```

# Description

This script merges CalMAPPER activity data with treatment polygons. This is a necessary step before analyzing prescribed fire data in CalMAPPER. 


# Define path to Calmapper and to the gdb file
```{r}
calmapper_dir <- fs::dir_ls(ref_path, recurse = T, glob = '*CalMAPPER', type = 'directory')
calmapper_files <- fs::dir_ls(calmapper_dir, recurse = T, glob = '*.gdb')
if(length(calmapper_files) > 1){
  stop( "There's more than one CalMAPPER .gdb file. script assumes only 1.")
}

```

```{r}
st_layers(calmapper_files)
act <- st_read(calmapper_files, layer = 'CMDash_Activities')
trt <- st_read(calmapper_files, layer = 'CMDash_TreatmentPols')
```


# Clean
## Remove non-treatment "activities"
```{r}
act <- act %>% 
  filter(!ACTIVITY_DESCRIPTION %in% c("GIS Validation", "Education Outreach", "Project Administration", "Planning Meeting", "Public Contacts", "Water Site Development"))
```

## Fix date format

### Activities
```{r}
act <- act %>% 
  mutate(ACTIVITY_START_date =  as.Date(ACTIVITY_START, format = "%m/%d/%Y")) %>% 
  mutate(PROJECT_START_DATE_date =  as.Date(ACTIVITY_END, format = "%m/%d/%Y")) 
```

```{r}
act <- act %>% 
  mutate(ACTIVITY_START_date = if_else(is.na(ACTIVITY_START_date), PROJECT_START_DATE_date, ACTIVITY_START_date))
```

## Treatments

# Sort by acreage
```{r}
act %>% 
  filter(ACTIVITY_START_date > "2020-01-01" & ACTIVITY_START_date < "2020-12-31") %>% 
  group_by(ACTIVITY_DESCRIPTION) %>% 
  summarize(acres = sum(TREATED_ACRES)) %>% 
  arrange(desc(acres)) %>% 
  print(n = 35)
```

# Merge Rx fire Activity data with treatment polygons
```{r}
# join act with trt to get geometry. use projectID, treatmentID
act_sf <- right_join(trt %>% select(PROJECT_ID, TREATMENT_ID), 
           act)

# clean up the data
act_sf <- act_sf[!st_is_empty(act_sf),] # remove empties
```

# Filter to fire and to completed treatments
```{r}
act_sf %>% 
  st_drop_geometry() %>% 
  group_by(ACTIVITY_DESCRIPTION) %>% 
  count() %>% 
  print(n=50)
```

```{r}
act_sf_fire <- 
  act_sf %>% 
  filter(ACTIVITY_DESCRIPTION %in% c("Broadcast Burn", "Cultural Burning", "Pile Burning", "Site Preparation (RxBurn)"))
```

# Save
```{r}
save(act_sf, file = "~/Reference data/CALFIRE spatial data/CalMAPPER/activities_fire.Rdata")
```

```{r}
write.csv(act_sf %>% st_drop_geometry(), file = "~/Reference data/CALFIRE spatial data/CalMapper/activities_fire.csv", row.names = F)
write.csv(trt %>% st_drop_geometry(), file = "~/Reference data/CALFIRE spatial data/CalMapper/treatments_fire.csv", row.names = F)
```

# Are there Rx fires recorded in Treatments data but not in Activities data?
```{r}
act_broadcast <- act_sf %>% 
  filter(ACTIVITY_DESCRIPTION == "Broadcast Burn")
```


```{r}
trt %>% 
  st_drop_geometry() %>% 
  group_by(TREATMENT_OBJECTIVE) %>% 
  count()
```


```{r}
trt_broadcast <- trt %>% 
  filter(TREATMENT_OBJECTIVE == "Broadcast Burn") %>% 
  filter(ACTIVITY_STATUS == "Complete")
```

## Check if there are treatment IDs in `act_broadcast` that aren't in `trt_broadcast`
```{r}
act_broadcast %>% 
  filter(!TREATMENT_ID %in% trt_broadcast$TREATMENT_ID)
```

```{r}
act_broadcast %>% 
  filter(!TREATMENT_NAME %in% trt_broadcast$TREATMENT_NAME)
```

```{r}
map <- mapview(list(trt_broadcast, act_broadcast), col.regions=list("red","blue"),col=list("red","blue"))
map
```

It's safe to use the Activities information and not the Treatment information.

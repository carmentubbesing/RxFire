---
title: "Q2_VIIRS_wo_records"
author: "Lisa Rosenthal"
date: "2023-09-19"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(fs)
library(terra)
library(mapview)
library(fasterize)

```

### Functions
```{r}

# extract data from vector layers
extract_polys <- function(polygons, points) {
  # polygons = vector_layers$solar
  # points = viirs[1:5000,"point_id"]
  
  intersects <- st_intersects(points, polygons, sparse = T)
  if ( length(unlist(intersects)) == 0)
    return(warning("No intersections"))
  else{
    intersections_list <- map(intersects, unlist)
    
    # warning if there's more than 1 polygon intersecting a point
    if(any(map_vec(intersections_list, length) > 1)){
      warning("Point(s) overlapped with more than 1 polygon. By default, choosing first one.")}
    # make sure points with no intersection become NA
    polygonIDs <- map_vec(intersections_list, 
                          ~ ifelse(sum(.x) == 0, NA, .x[1]) )
    newcols <- st_drop_geometry(polygons)[polygonIDs, ]
    return(as_tibble(newcols))
  }
}

# add geometry id
add_geomID <- function(sf_object){
  # ensure geometry column is named properly
  st_geometry(sf_object) <- 'geometry'
  # add geom id
  sf_object %>%
  mutate(geom_id = row_number(), .before = geometry) %>% 
  group_by(geometry) %>%
  mutate(geom_id = ifelse(n() > 1, geom_id[1], geom_id)) %>% 
  ungroup()
}
```
## Goal

Create a cleaned up version of VIIRS points consisting of high confidence fire points. 

Remove points that are
- On ag land, urban, water (from NASS CDL)
- campgrounds
- power plants
- solar farms

Other layers that could be important
- Jurisdictions/Land management agency


to rid stationary hotspots, could rasterize the points and calculate the density of viirs points during the non-rx fire months. >4 unique days get thrown out? need to mask out wildfire.

## Load CA boundary data

Reminder that I need to redownload VIIRS to completely cover the southern part of CA!

```{r}
# California boundary
ca_path <- file.path(ref_path, 'CA boundary/ca-state-boundary/CA_State_TIGER2016.shp')
CA <- st_read(ca_path) 

# VIIRS fire detects
viirs_dir <- file.path(ref_path, 'VIIRS/CA_2020')
viirs_shps <- dir_ls(viirs_dir, recurse = T, glob = '*.shp')
viirs_shps <- viirs_shps[!grepl("viirs_nonAg", viirs_shps)] # don't want that file
viirs <- map_df(viirs_shps, st_read) %>% st_transform(st_crs(CA))
viirs <- viirs[CA,]

# get viirs into PST, not UTC
viirs <- viirs %>%
  mutate(
    # get datetime in PST
    .before = ACQ_DATE,
    hour = str_sub(ACQ_TIME, 1, 2),
    minute = str_sub(ACQ_TIME, 3, 4),
    time = paste(hour, minute, sep = ':'),
    datetime = ymd_hm(paste(ACQ_DATE, time)) %>% with_tz('US/Pacific'),
    date = date(datetime),
    # detects in the middle of the night (e.g. 3am) should be considered night before
    date_adj = case_when(DAYNIGHT == 'N' ~ date - 1, T ~ date),
    jday = yday(date),
    jday_adj = ifelse(DAYNIGHT == 'N', yday(date_adj), jday),
  ) %>%
  select(-c(hour, minute, time, ACQ_DATE, ACQ_TIME)) %>% 
  mutate(point_id = row_number(), .before = LATITUDE)


# vis extent of the two. 
st_make_grid(st_bbox(CA), n = 1) %>% plot(col = 'maroon4')
st_make_grid(st_bbox(viirs), n = 1) %>% plot(add = T, col = 'tan')
plot(st_geometry(CA), add = T)


```


## Extract things around the VIIRS points

Import the data to extract with the VIIRS points
```{r}

vector_layers <- read_rds('outputs_spatial/vector/extract_viirs.rds')
rasts <- rast('outputs_spatial/raster/extract_viirs.tif')

```

Extract data with VIIRS points. 

```{r}

# raster data
extracted_rasters <- terra::extract(x = rasts, viirs)



# vector data
vector_names <- list(c("county"),
                     c("camping"),
                     c("power_source", 'power_capacity'),
                     c("solar"))
tictoc::tic()
extracted_vectors <- map(vector_layers, ~ extract_polys(.x, viirs)) %>% 
  map2(., vector_names, ~ set_names(.x, .y)) %>% 
  bind_cols
tictoc::toc() # 26.6sec


# Check out how often viirs intersects with these things...
# not much. The points (e.g. camping) probably underesimated, but oh well. 
apply(extracted_vectors, 2, function(x) 100 * mean(!is.na(x)))

viirs_ex <- tibble(viirs, extracted_rasters, extracted_vectors)


```


## Fire data

I combined fire data in the script `prep_fire_polygons.Rmd`. It combines FRAP (rx and wildfire), CalMAPPER, and FACTS. Also extract fire data, similar to above.

Originally I wanted information about all polygons, even those that were overlapping each other, but I needed to create a loop that took forever. So, still extracting information on the first intersecting polygon.

```{r}
fires <- read_rds(here::here('outputs_spatial/vector/fire_records_2020.rds'))

# assign a polygon ID to each polygon. Seems like the datasets don't always have a unique ID for each row. 
fires <- map(fires, add_geomID)

# choose the columns to be extracted from each layer
cols_to_keep <- list(
  frap_rx = c("geom_id", "TREATMENT_ID", "TREATMENT_NAME", "AGENCY", "START_DATE", "END_DATE", 'TREATED_AC'),
  frap_wf = c("geom_id", "INC_NUM", "FIRE_NAME", "AGENCY", "ALARM_DATE", "CONT_DATE"),
  CalMAPPER = c("geom_id", "TREATMENT_ID", "AQ_ID", 'pile_burn', 'broadcast_burn', "ACTIVITY_START", "ACTIVITY_END", "duration"), 
  FACTS = c("geom_id", "FACTS_ID", "NAME", "ACTIVITY", "DATE_COMPL")
)
fires <- map2(fires, cols_to_keep, ~ select(.x, all_of(.y)))


# extract fire data. 
tictoc::tic()
extracted_fires <- map(fires, ~ extract_polys(.x, viirs))
tictoc::toc() # 26.6sec

# add prefixes to column names and join.
prefixes <- c("FRAPrx", "FRAPwf", "CM", "FACTS")
add_prefix <- function(df, prefix){
  names(df) <- glue::glue("{prefix}_{names(df)}")
  return(df)
}
extracted_fires <- map2(extracted_fires, prefixes, add_prefix) %>% 
  bind_cols()

```

Ok, now I've extracted info on fires and things that might affect viirs detections. Let's make sure the extractions make sense adn then merge it all together. 

```{r}
# same number of rows. good. merge it together. 
dim(viirs_ex)
dim(extracted_fires)
viirs_ex <- tibble(viirs_ex, extracted_fires)
```


Filter out VIIRS points that spatially AND temporally overlap with wildfires for now. Wow, there are still ~49k VIIRS detections. 
```{r}

# these viirs points spatially and temporally overlap with wildfire. Remove for now. 
viirs_wf <- viirs_ex %>% 
  filter(!is.na(FRAPwf_geom_id) &
           date_adj >= FRAPwf_ALARM_DATE & date_adj <= FRAPwf_CONT_DATE) 

# these should theoretically be from things other than wildfire. 
viirs_notwf <- viirs_ex %>% 
  filter(!point_id %in% viirs_wf$point_id)
nrow(viirs_notwf)

```


Identify areas with VIIRS hotspots? Make sure they're outside of wildfire perimeters.

To rid stationary hotspots, could rasterize the points and calculate the density of viirs points during the non-rx fire months. >4 unique days get thrown out? It's probably just picking up wildfire, which will get masked out anyways. 

```{r}
months_noRxfire <- c(7:9)
viirs_summer <- viirs_notwf %>% 
  filter(month(date_adj) %in% months_noRxfire) %>% 
  st_as_sf(sf_column_name = "geometry")
viirs_density <- rasterize(viirs_summer, rasts$SRA, fun = 'length')

# percentage of pixels with >= 4 VIIRS detections in the summer 
global(viirs_density >= 4, fun = function(x) mean(x, na.rm = T)*100)
hist(viirs_density)
```




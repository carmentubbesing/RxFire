---
title: "merge_CalMapper_PFIRS"
output: 
  html_document:
    toc: TRUE
date: "2023-09-29"
---

```{r, include = F}
require(tidyverse)
require(sf)
require(mapview)
require(leafem)
require(lubridate)
require(patchwork)
require(scales)
```

This script creates a merged list of treatments from both CalMapper and PFIRS with:
    -  duplicates removed from PFIRS, defined as within 1 km and 30 days from CalMapper record
    -  years 2020-2022
    -  filtered to AEPP threshold
    -  buffered overlay method to account for PFIRS being point data

# Load data

```{r}
file = "Rdata/CalMapper_activities_fire.Rdata"
load(file)
```

```{r}
file = "Rdata/PFIRS_2017-2022_pull2023.Rdata"
load(file)
```

# Filter to years 2020-2022

## Check whether YEAR matches activity dates in CalMapper
```{r}
cm %>% 
  group_by(YEAR) %>% 
  ggplot(aes(x = as.factor(YEAR), y = ACTIVITY_START))+
  geom_point(position = position_jitter())
```

```{r}
cm %>% 
  group_by(YEAR) %>% 
  ggplot(aes(x = as.factor(YEAR), y = ACTIVITY_END))+
  geom_point(position = position_jitter())
```

Yup, it doesn't look like there are issues

## CalMapper
```{r}
cm <- cm %>% 
  filter(YEAR %in% seq(2020, 2022))
```

## PFIRS

```{r}
pfirs %>% 
  group_by(Year) %>% 
  ggplot(aes(x = as.factor(Year), y = Burn_Date))+
  geom_point(position = position_jitter())
```

```{r}
pfirs <- pfirs %>% 
  filter(Year %in% seq(2020, 2022))
```


# Filter by size according to AERR thresholds

## CalMapper
```{r}
cm %>% 
  st_drop_geometry() %>% 
  group_by(ACTIVITY_DESCRIPTION) %>% 
  count()
```

```{r}
nrow_old <- nrow(cm)

cm <- cm %>% 
  filter((ACTIVITY_DESCRIPTION == "Pile Burning" & TREATED_ACRES >= 25) | (ACTIVITY_DESCRIPTION %in% c("Broadcast Burn", "Cultural Burning") & TREATED_ACRES >= 50))

deleted_n <- nrow_old - nrow(cm)
print(paste("Deleted", deleted_n, "records below the size threshold"))
```

## PFIRS
```{r}
pfirs %>% 
  st_drop_geometry() %>% 
  group_by(Burn_Type) %>% 
  count()
```

### Add a column for "pile" or "broadcast" since the burn type column is messy
```{r}
pfirs <- pfirs %>% 
  mutate(Burn_Type_Simple = case_when(
    Burn_Type %in% c("Hand Pile", "Hand Piles", "Landing Pile", "Landing Piles", "Machine Pile", "Machine Piles") ~ "Pile", 
    Burn_Type == "Broadcast" ~ "Broadcast",
    Burn_Type %in% c("Multiple Fuel Types", "Multiple Fuels", "UNK", "Unknown") ~ "Unknown/Multiple", 
    TRUE ~ NA
  ))
```

```{r}
pfirs %>% 
  st_drop_geometry() %>% 
  group_by(Burn_Type, Burn_Type_Simple) %>% 
  count()
```


## Filter to burns within the AERR size thresholds
```{r}
nrow_old <- nrow(pfirs)

pfirs <- pfirs %>% 
  filter((Burn_Type_Simple == "Pile" & Acres_Burned >= 25) | (Burn_Type_Simple %in% c("Broadcast", "Unknown/Multiple") & Acres_Burned >= 50))

deleted_n <- nrow_old - nrow(pfirs)
print(paste("Deleted", deleted_n, "records below the size threshold"))
```

# Sync up crs's
```{r}
if(object.size(cm) > object.size(pfirs)){
  print("CalMapper is more GB than PFIRS")
}
```

```{r}
pfirs <- st_transform(pfirs, st_crs(cm))
```


# Add ID column to PFIRS
```{r}
pfirs <- pfirs %>% 
  mutate(ID_CT = seq(1, nrow(pfirs)))
```

# Add Data_source column
```{r}
pfirs <- pfirs %>% 
  mutate(Data_source = "PFIRS")
```

```{r}
cm <- cm %>% 
  mutate(Data_source = "CalMapper")
```

# Plot filtered data together

## Convert year columns to factors
```{r}
pfirs$Year <- as.factor(pfirs$Year)
cm$Year <- as.factor(cm$YEAR)
cm <- cm %>% 
  select(-YEAR)
```


## Buffer PFIRS

```{r}
pfirs_buff <- st_buffer(pfirs, dist = 1000)
```

### Write
```{r}
st_write(pfirs_buff, dsn = "shapefiles", layer = "pfirs_buffer", driver = "ESRI Shapefile", delete_layer = T)
```


### Plot using mapview
```{r}
st_crs(pfirs) == st_crs(cm)

mapview(pfirs, zcol = "Year", col.regions = colors, alpha.regions = 0.5)+
  mapview(cm, zcol = "Year", col.regions = colors,  alpha.regions = 0.5)+
  mapview(pfirs_buff, zcol = "Year", col.regions = colors, alpha.regions = 0.3)
```

# Plot without duplicates removed at all

## Calculate agreage of each, by year
```{r}
table <- pfirs %>% 
  st_drop_geometry() %>% 
  group_by(Year) %>% 
  summarize(ac = sum(Acres_Burned)) %>% 
  mutate(source = "pfirs")
table
```

```{r}
table_method0 <- cm %>% 
  st_drop_geometry() %>% 
  group_by(Year) %>% 
  summarize(ac = sum(TREATED_ACRES)) %>% 
  mutate(source = "cm") %>% 
  full_join(table)
table_method0
```

## Plot
```{r}
plot_method0 <- ggplot(table_method0 %>% group_by(source))+
  geom_col(aes(x = Year, y = ac, group = source, fill = source))+
  ylab("acres")+
  ggtitle("No duplicates removed")+
  theme_minimal()+
  guides(fill = "none")+
  ylim(c(0,110000))
plot_method0
```


# Find duplicates

## Rename columns with identifier for source
```{r}
pfirs_buff_dups <- pfirs_buff %>% 
  rename(Year_pfirs = Year) %>% 
  rename(Date_pfirs = Burn_Date) %>% 
  rename(ID_PFIRS_CT = ID_CT) %>% 
  rename(acres_pfirs = Acres_Burned) %>% 
  rename(Agency_pfirs = Agency)
```

```{r}
cm_dups <- cm %>% 
  ungroup %>% 
  rename(Year_cm = Year) %>% 
  rename(ACTIVITY_START_cm = ACTIVITY_START) %>% 
  rename(ACTIVITY_END_cm = ACTIVITY_END) %>% 
  rename(ID_CM_Trt = AQ_ID) %>% 
  rename(acres_cm = TREATED_ACRES) %>% 
  rename(Agency_cm = AGENCY_NAME) %>% 
  rename()
```

## Spatial overlay
```{r}
dups <- st_intersection(pfirs_buff_dups, cm_dups)
```


## Filter `dups` to only rows where dates are THE SAME between the two data sets

### Filter to same year
```{r}
dups <- dups %>% 
  filter(Year_pfirs == Year_cm)
```

### Look at date differences
```{r}
dups <- dups %>% 
  mutate(diff_dates_start = difftime(Date_pfirs, ACTIVITY_START_cm, units = "days")) %>% 
  mutate(diff_dates_end = difftime(Date_pfirs, ACTIVITY_END_cm, units = "days"))
```


# Remove PFIRS points that meet the following criteria:
    -  within the CAL FIRE date range
    -  within 1 km of the same polygon

## Date match
```{r}
dups_daily <- dups %>% 
  filter(Date_pfirs >= ACTIVITY_START_cm & Date_pfirs <= ACTIVITY_END_cm) 
```

#### Check
```{r}
dups_daily %>% 
  select(Date_pfirs, ACTIVITY_START_cm, ACTIVITY_END_cm) %>% 
  st_drop_geometry() %>% 
  tail()
```

## Reorder columns

```{r}
dups_daily <- dups_daily %>% 
  select(Burn_Unit, ACTIVITY_NAME, Date_pfirs, ACTIVITY_START_cm, ACTIVITY_END_cm, acres_pfirs, acres_cm, Agency_cm, Agency_pfirs, Burn_Type_Simple, ACTIVITY_DESCRIPTION, Burn_Type_Simple, everything())
```

```{r}
print(paste("There are ", nrow(dups_daily), "rows that are duplicated."))
print(paste("-  Of those, there are ", length(unique(dups_daily$ID_PFIRS_CT)), "unique PFIRS records"))
print(paste("-  and ", length(unique(dups_daily$ID_CM_Trt)), "unique CalMapper records"))
```

# Handle Duplicates

## Method 1: Remove PFIRS points 

### Remove duplicates from PFIRS
```{r}
pfirs_no_dups_daily <- pfirs %>% 
  filter(!ID_CT %in% dups_daily$ID_PFIRS_CT)
```

### Combine pfirs and CalMapper

#### Sync column names
```{r}
cm_merge <- cm %>% 
  rename(Agency = AGENCY_NAME,
          Acres_Burned = TREATED_ACRES,
         Burn_Type_Simple = ACTIVITY_DESCRIPTION) %>% 
  select(Data_source, TREATMENT_NAME, Acres_Burned, Burn_Type_Simple, ACTIVITY_START, ACTIVITY_END, Agency, everything()) %>% 
  mutate(gis_acres_treatment = as.numeric(st_area(cm)/4046.86)) %>% 
  st_drop_geometry()
```

```{r}
pfirs_merge <- pfirs_no_dups_daily %>% 
  rename(TREATMENT_NAME = Burn_Unit) %>% 
  st_drop_geometry() %>% 
  select(Data_source, TREATMENT_NAME, Acres_Burned, Burn_Type_Simple, Burn_Date, Agency, Burn_Type, everything())
  
```

#### Merge
```{r}
merged <- full_join(cm_merge, pfirs_merge)
nrow(pfirs_merge)+nrow(cm_merge) == nrow(merged)
```

```{r}
merged <- merged %>% 
  select(Data_source, TREATMENT_NAME, Acres_Burned, Burn_Type_Simple, ACTIVITY_START, ACTIVITY_END, Burn_Date, Agency, everything()) %>% 
  arrange(TREATMENT_NAME)
```

#### Save
```{r}
write_excel_csv(merged, file = "excel/CalMapper_PFIRS_Method1.xls")
```

### Plot acreage
```{r}
table_method1 <- merged %>% 
  group_by(Year, Data_source) %>% 
  summarize(acres = sum(Acres_Burned)) 
plot_method1 <- table_method1 %>% 
  ggplot()+
  geom_col(aes(x = Year, y = acres, fill = Data_source))+
  theme_minimal()+
  ggtitle("Method 1")+
  ylim(c(0,110000))+
  guides(fill = "none")+
  ylab("")
plot_method1
```


## Method 2: Remove whichever has the lower acreage
#### Sync column names
```{r}
cm_dup <- dups_daily %>% 
  st_drop_geometry() %>% 
  select(ID_CM_Trt) %>% 
  distinct() 
cm_dup
```


For the CalMapper polygons with multiple overlapping PFIRS points, add up the acreage in the PFIRS points. If the total acreage is greater than the treated acreage in CM, then delete the CM polygon. Otherwise, delete the PFIRS points.
```{r}
count = 0
cm_merge <- cm %>% 
  ungroup() %>% 
  mutate(gis_acres_treatment = as.numeric(st_area(cm)/4046.86)) %>% 
  st_drop_geometry()
pfirs_merge <- pfirs %>% ungroup() %>% st_drop_geometry()
for(i in 1:nrow(cm_dup)){
  cm_ID_i <- cm_dup[i,1] %>% unlist()
  test <- dups_daily %>% filter(ID_CM_Trt == cm_ID_i)
  if(nrow(test)==1){
    count = count + 1 
    if(test$acres_cm >= test$acres_pfirs){
      pfirs_merge <- pfirs_merge %>% 
        filter(!ID_CT %in% test$ID_PFIRS_CT)
    } else{
      cm_merge <- cm_merge %>% 
        filter(AQ_ID != cm_ID_i)
      print("deleted CalMapper")
    }
  } else if (nrow(test)>1){
    if(test$acres_cm[1] >= sum(test$acres_pfirs)){
      pfirs_merge <- pfirs_merge %>% 
        filter(!ID_CT %in% test$ID_PFIRS_CT)
      print("deleted multiple PFIRS")
      print(test$ID_PFIRS_CT)
    } else{
      cm_merge <- cm_merge %>% 
        filter(AQ_ID != cm_ID_i)
      print("deleted CalMapper")
    }
  }
}
```

```{r}
print(paste("Out of all the duplicates,", count, "are 1:1 duplicates, and", nrow(cm_dup)-count, "CalMapper ID's are more complicated"))
```

```{r}
print(paste("There were", nrow(cm)-nrow(cm_merge), "rows deleted from CalMapper"))
print(paste("There were", nrow(pfirs)-nrow(pfirs_merge), "rows deleted from PFIRS"))
```

### Merge 

```{r}
cm_merge <- cm_merge %>% 
  rename(Agency = AGENCY_NAME,
          Acres_Burned = TREATED_ACRES,
         Burn_Type_Simple = ACTIVITY_DESCRIPTION) %>% 
  select(Data_source, TREATMENT_NAME, Acres_Burned, Burn_Type_Simple, ACTIVITY_START, ACTIVITY_END, Agency, everything()) %>% 
  st_drop_geometry()
```

```{r}
pfirs_merge <- pfirs_merge %>% 
  rename(TREATMENT_NAME = Burn_Unit) %>% 
  st_drop_geometry() %>% 
  select(Data_source, TREATMENT_NAME, Acres_Burned, Burn_Type_Simple, Burn_Date, Agency, Burn_Type, everything())
```

```{r}
merged_method2 <- full_join(cm_merge, pfirs_merge)
nrow(pfirs_merge)+nrow(cm_merge) == nrow(merged)
```

### Plot acreage
```{r}
table_method2 <- merged_method2 %>% 
  group_by(Year, Data_source) %>% 
  summarize(acres = sum(Acres_Burned))
plot_method2 <- table_method2 %>% 
  ggplot()+
  geom_col(aes(x = Year, y = acres, fill = Data_source))+
  theme_minimal()+
  ggtitle("Method 2")+
  ylim(c(0,110000))+
  ylab("")+
    guides(fill = "none")
plot_method2
```

## Method 3: Method 2 but with a 30-day buffer

#### Filter by date
```{r}
dups_monthly <- dups %>% 
  filter((Date_pfirs >= ACTIVITY_START_cm & Date_pfirs <= ACTIVITY_END_cm) | (diff_dates_start>30 & diff_dates_end>30) | (diff_dates_start< -30 & diff_dates_end< -30)) 
```

#### Create list of CM unique records in `dups_monthly`
```{r}
cm_dup <- dups_monthly %>% 
  st_drop_geometry() %>% 
  select(ID_CM_Trt) %>% 
  distinct() 
cm_dup
```

For the CalMapper polygons with multiple overlapping PFIRS points, add up the acreage in the PFIRS points. If the total acreage is greater than the treated acreage in CM, then delete the CM polygon. Otherwise, delete the PFIRS points.
```{r}
count = 0

cm_merge <- cm %>% 
  ungroup() %>% 
  mutate(gis_acres_treatment = as.numeric(st_area(cm)/4046.86)) %>% 
  st_drop_geometry()

pfirs_merge <- pfirs %>% ungroup() %>% st_drop_geometry()

for(i in 1:nrow(cm_dup)){
  cm_ID_i <- cm_dup[i,1] %>% unlist()
  test <- dups_monthly %>% filter(ID_CM_Trt == cm_ID_i)
  if(nrow(test)==1){
    count = count + 1 
    if(test$acres_cm >= test$acres_pfirs){
      pfirs_merge <- pfirs_merge %>% 
        filter(!ID_CT %in% test$ID_PFIRS_CT)
    } else{
      cm_merge <- cm_merge %>% 
        filter(AQ_ID != cm_ID_i)
      print("deleted CalMapper")
    }
  } else if (nrow(test)>1){
    if(test$acres_cm[1] >= sum(test$acres_pfirs)){
      pfirs_merge <- pfirs_merge %>% 
        filter(!ID_CT %in% test$ID_PFIRS_CT)
      print("deleted multiple PFIRS")
      print(test$ID_PFIRS_CT)
    } else{
      cm_merge <- cm_merge %>% 
        filter(AQ_ID != cm_ID_i)
      print("deleted CalMapper")
    }
  }
}
```

```{r}
print(paste("Out of all the duplicates,", count, "are 1:1 duplicates, and", nrow(cm_dup)-count, "CalMapper ID's are more complicated"))
```

```{r}
print(paste("There were", nrow(cm)-nrow(cm_merge), "rows deleted from CalMapper"))
print(paste("There were", nrow(pfirs)-nrow(pfirs_merge), "rows deleted from PFIRS"))
```

### Merge 

```{r}
cm_merge <- cm_merge %>% 
  rename(Agency = AGENCY_NAME,
          Acres_Burned = TREATED_ACRES,
         Burn_Type_Simple = ACTIVITY_DESCRIPTION) %>% 
  select(Data_source, TREATMENT_NAME, Acres_Burned, Burn_Type_Simple, ACTIVITY_START, ACTIVITY_END, Agency, everything()) %>% 
  st_drop_geometry()
```

```{r}
pfirs_merge <- pfirs_merge %>% 
  rename(TREATMENT_NAME = Burn_Unit) %>% 
  st_drop_geometry() %>% 
  select(Data_source, TREATMENT_NAME, Acres_Burned, Burn_Type_Simple, Burn_Date, Agency, Burn_Type, everything())
```

```{r}
merged_method3 <- full_join(cm_merge, pfirs_merge)
nrow(pfirs_merge)+nrow(cm_merge) == nrow(merged_method3)
```

### Plot acreage
```{r}
table_method3 <- merged_method3 %>% 
  group_by(Year, Data_source) %>% 
  summarize(acres = sum(Acres_Burned))
plot_method3 <- table_method3 %>% 
  ggplot()+
  geom_col(aes(x = Year, y = acres, fill = Data_source))+
  theme_minimal()+
  ggtitle("Method 3")+
  ylim(c(0,110000))+
  ylab("")
plot_method3
```

# Plot bar charts side-by-side

## Add numeric labels

### Method 0
```{r}
table_method0 <- table_method0 %>% 
  select(Year, source, ac) %>% 
  group_by(Year) %>% 
  mutate(total = sum(ac) %>% round(-2))
table_method0
```

### Method 1
```{r}
table_method1 <- table_method1 %>% 
  group_by(Year) %>% 
  mutate(total = sum(acres) %>% round(-2))
table_method1
```

### Method 2
```{r}
table_method2 <- table_method2 %>% 
  group_by(Year) %>% 
  mutate(total = sum(acres) %>% round(-2))
table_method2
```

### Method 3
```{r}
table_method3 <- table_method3 %>% 
  group_by(Year) %>% 
  mutate(total = sum(acres) %>% round(-2))
table_method3
```

```{r}
plot_method0 <- plot_method0+
  geom_text(data = table_method0, aes(x = Year, y = total, label = comma(total)), vjust = -0.5)+
  xlab("")
```

```{r}
plot_method1 <- plot_method1+
  geom_text(data = table_method1, aes(x = Year, y = total, label = comma(total)), vjust = -0.5)+
  xlab("")
```


```{r}
plot_method2 <- plot_method2+
  geom_text(data = table_method2, aes(x = Year, y = total, label = comma(total)), vjust = -0.5)+
  xlab("")
```

```{r}
plot_method3 <- plot_method3+
  geom_text(data = table_method3, aes(x = Year, y = total, label = comma(total)), vjust = -0.5)+
  xlab("")
```


```{r}
all_plots <- (plot_method0 | plot_method1 | plot_method2 | plot_method3)
all_plots
ggsave("figures/duplicates_bar_charts.png", width = 12, height = 5, units = c("in"))
```


```{r}

# Sample data
data <- data.frame(
  Category = c("A", "B", "C", "D"),
  Value = c(20, 35, 15, 40),
  Group = c("Group1", "Group1", "Group2", "Group2")
)

# Create the stacked bar plot
p <- ggplot(data, aes(x = Category, y = Value, fill = Group)) +
  geom_col(position = "stack") +  # Create the stacked bar plot
  geom_text(data = data, aes(x = Category, y = Value, label = Value), vjust = -0.5)  # Add number labels above the bars

# Adjust the label position (vjust) as needed for your plot
# vjust = -0.5 moves the labels above the bars, you can adjust it to your preference
# hjust can be used to align the labels left, right, or center within the bars

# Display the plot
print(p)

```


# Write duplicates to shapefile

```{r}
# dups_daily_esri <- dups_daily %>% 
  # rename(Obj = TREATMENT_OBJECTIVE) %>% 
  # select(-TREATMENT_SHAPE, -Data_source, -Data_source.1)
```


```{r}
# st_write(dups_daily_esri, dsn = "shapefiles", layer = "duplicates_final", driver = "ESRI Shapefile", delete_layer = T)
# 
# dups_daily_point <- pfirs %>% 
#   filter(ID_CT %in% dups_daily$ID_PFIRS_CT) 
# 
# st_write(dups_daily_point, dsn = "shapefiles", layer = "duplicates_POINT", driver = "ESRI Shapefile", delete_layer = T)
```
